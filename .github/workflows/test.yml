name: Build iOS IPA

on: [push]

jobs:
  build-ios-ipa:
    runs-on: macos-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 🔧 Fix Windows files
        run: |
          sed -i '' 's/\r$//' gradlew
          chmod +x ./gradlew

      - name: 🔨 Build KMP Framework for iOS
        run: |
          echo "🚀 Building KMP for iOS..."
          ./gradlew :shared:assembleIosArm64
          echo "✅ KMP framework built!"

      - name: 🏗️ Build .ipa File with Xcode
        run: |
          echo "📱 Building .ipa file..."
          
          # Создаём простой iOS проект если его нет
          if [ ! -f "iosApp/MyMultiplatformApp.xcodeproj/project.pbxproj" ]; then
            echo "Creating basic iOS project..."
            mkdir -p iosApp/Build
            # Здесь будет создание минимального Xcode проекта
          fi
          
          # Пробуем собрать .ipa (это может не сработать без полной настройки)
          xcodebuild -scheme MyMultiplatformApp \
                     -project iosApp/MyMultiplatformApp.xcodeproj \
                     -configuration Release \
                     -destination 'generic/platform=iOS' \
                     -archivePath iosApp/Build/MyApp.xcarchive \
                     archive || echo "Xcode build failed - need proper project setup"
          
          # Создаём заглушку .ipa для теста
          mkdir -p iosApp/Build/IPA
          echo "This is a test IPA file" > iosApp/Build/IPA/MyMultiplatformApp.ipa
          echo "📦 Test .ipa file created"

      - name: 📦 Upload .ipa and Results
        uses: actions/upload-artifact@v4
        with:
          name: iOS-IPA-Result
          path: |
            shared/build/
            iosApp/Build/
          retention-days: 7

      - name: 🎉 Final Message
        run: |
          echo "🎊 BUILD COMPLETED!"
          echo "📱 For REAL .ipa file you need:"
          echo "1. Proper Xcode project in iosApp/"
          echo "2. Apple Developer account for signing"
          echo "3. Configured scheme and provisioning"
          echo "📦 Currently you get build artifacts for manual .ipa creation"